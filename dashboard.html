<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalSphere - Your Health Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        :root {
            --bg-main-overlay-start: rgba(8, 10, 18, 0.65);
            --bg-main-overlay-end: rgba(15, 18, 28, 0.85);
            --pane-bg: rgba(28, 32, 48, 0.45);
            --pane-bg-blur: 18px;
            --pane-border: rgba(255, 255, 255, 0.06);
            --pane-shadow: rgba(0, 0, 0, 0.35);
            --widget-bg: rgba(36, 40, 58, 0.7);
            --widget-border: rgba(255, 255, 255, 0.04);
            --widget-hover-bg: rgba(44, 48, 68, 0.8);
            --element-bg: rgba(46, 50, 70, 0.8);
            --element-border: rgba(255, 255, 255, 0.05);
            --element-hover-bg: rgba(56, 60, 82, 0.9);
            --text-primary: #ECEFF4;
            --text-secondary: #B8C2D8;
            --text-muted: #8A95B0;
            --text-widget-description: #AAB4CC;
            --accent-primary: #48E0D8;
            --accent-primary-darker: #3AC0B8;
            --accent-secondary: #987EFF;
            --accent-secondary-rgb: 152, 126, 255;
            --accent-primary-alpha-10: rgba(72, 224, 216, 0.1);
            --accent-secondary-alpha-10: rgba(152, 126, 255, 0.1);
            --accent-primary-glow: 0 0 12px rgba(72, 224, 216, 0.25);
            --accent-secondary-glow: 0 0 12px rgba(152, 126, 255, 0.25);
            --danger-accent: #F87171;
            --warning-accent: #FBBF24;
            --mood-color-0: '#A0AEC0';
            --mood-color-1: '#828CA0';
            --mood-color-2: '#E0C082';
            --mood-color-3: '#B09CF2';
            --mood-color-4: '#7FE8E0';
            --font-family: 'Poppins', sans-serif;
            --border-radius-xl: 26px;
            --border-radius-lg: 20px;
            --border-radius-md: 14px;
            --border-radius-sm: 10px;
            --header-gradient: linear-gradient(95deg, var(--accent-primary), var(--accent-secondary));
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-image:
                radial-gradient(circle at 50% 15%, rgba(var(--accent-secondary-rgb), 0.05) 0%, transparent 40%),
                radial-gradient(circle at center, var(--bg-main-overlay-start) 0%, var(--bg-main-overlay-end) 100%),
                url('https://images.rawpixel.com/image_social_landscape/czNmcy1wcml2YXRlL3Jhd3BpeGVsX2ltYWdlcy93ZWJzaXRlX2NvbnRlbnQvbHIvcm0zNzNiYXRjaDE1LWJnLTExLmpwZw.jpg');
            background-size: cover; background-position: center;
            background-repeat: no-repeat; background-attachment: fixed;
            color: var(--text-primary); padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; font-weight: 300; overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(10, 12, 20, 0.5); border-radius: var(--border-radius-sm); }
        ::-webkit-scrollbar-thumb { background-color: var(--element-bg); border-radius: var(--border-radius-sm); border: 2px solid rgba(10, 12, 20, 0.5); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--element-hover-bg); }

        .dashboard-container {
            width: 100%; max-width: 1550px; background: var(--pane-bg);
            backdrop-filter: blur(var(--pane-bg-blur)); -webkit-backdrop-filter: blur(var(--pane-bg-blur));
            border: 1px solid var(--pane-border); border-radius: var(--border-radius-xl);
            box-shadow: 0 15px 50px var(--pane-shadow); padding: 25px 30px; margin: 15px auto;
        }

        .dashboard-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; gap: 20px;
        }
        .dashboard-header h1 {
            font-size: 2.2em; font-weight: 600; background-image: var(--header-gradient);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(0 1.5px 2.5px rgba(0,0,0,0.2));
            margin-right: auto; white-space: nowrap;
        }

        .calendar-widget {
            background-color: var(--widget-bg); color: var(--text-secondary);
            padding: 12px 14px; border-radius: var(--border-radius-lg);
            border: 1px solid var(--widget-border); width: 100%;
            max-width: 280px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-family: var(--font-family); flex-shrink: 0;
        }
        .calendar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; padding-bottom: 6px;
            border-bottom: 1px solid var(--widget-border);
        }
        .month-year { font-size: 0.9em; font-weight: 500; color: var(--text-primary); }
        .nav-buttons button {
            background: none; border: none; color: var(--text-secondary);
            font-size: 0.95em; cursor: pointer; padding: 3px 5px;
            border-radius: var(--border-radius-sm); transition: color 0.2s, background-color 0.2s;
        }
        .nav-buttons button:hover { color: var(--text-primary); background-color: var(--element-hover-bg); }
        .days-of-week, .calendar-dates { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .days-of-week div { font-size: 0.55em; color: var(--text-muted); padding-bottom: 4px; font-weight: 500; text-transform: uppercase; }
        .calendar-dates div {
            font-size: 0.7em; cursor: pointer; position: relative;
            border-radius: 50%; width: 24px; height: 24px;
            display: flex; justify-content: center; align-items: center;
            margin: 1px auto; transition: all 0.2s ease-in-out;
        }
        .calendar-dates div:hover:not(.selected):not(.other-month) { background-color: var(--element-hover-bg); transform: scale(1.08); }
        .calendar-dates .other-month { color: var(--text-muted); opacity: 0.3; cursor: default; }
        .calendar-dates .other-month:hover { background-color: transparent; transform: none; }
        .calendar-dates .selected {
            background-color: var(--accent-secondary); color: var(--text-primary);
            font-weight: 600; box-shadow: var(--accent-secondary-glow); transform: scale(1.08);
        }
        .calendar-dates .today:not(.selected) {
            border: 1.5px solid var(--accent-primary); color: var(--accent-primary);
            box-shadow: var(--accent-primary-glow);
        }
        .calendar-dates .today.selected { border-color: transparent; }
        .calendar-dates .event-dot {
            position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
            width: 3px; height: 3px; background-color: var(--accent-primary);
            border-radius: 50%;
        }
        .calendar-dates .selected .event-dot { background-color: var(--text-primary); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(310px, 1fr)); gap: 20px; }

        @media (min-width: 1024px) {
            .dashboard-grid { grid-template-columns: repeat(3, 1fr); }
            .widget.vital-signs-widget { grid-column: span 2; }
        }
         @media (min-width: 1400px) {
            .widget.vital-signs-widget { grid-row: span 2; grid-column: span 1; }
         }

        .widget {
            background: var(--widget-bg); border-radius: var(--border-radius-lg); padding: 20px 25px;
            border: 1px solid var(--widget-border); display: flex; flex-direction: column;
            transition: all 0.3s ease-out;
            opacity: 0; transform: translateY(20px) scale(0.98);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .widget.is-visible { opacity: 1; transform: translateY(0) scale(1); }
        .widget:hover {
            background: var(--widget-hover-bg); border-color: rgba(255, 255, 255, 0.08);
            transform: translateY(-4px) scale(1.005); box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .widget-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 8px; color: var(--text-primary);
        }
        .widget-header .widget-title { font-size: 1.2em; font-weight: 600; letter-spacing: 0.3px; }
        .widget-header i { font-size: 1.25em; color: var(--text-secondary); width: 18px; text-align: center; }

        .widget-description {
            font-size: 0.78em; color: var(--text-widget-description);
            margin-bottom: 15px; padding-bottom: 12px;
            border-bottom: 1px solid var(--widget-border);
            font-weight: 300; line-height: 1.45;
        }
        .widget-content { flex-grow: 1; display: flex; flex-direction: column; }

        .dna-visual-container {
            flex: 0 0 auto; width: clamp(140px, 35%, 200px); height: 250px;
            display: flex; align-items: center; justify-content: center;
            perspective: 700px; margin: 5px auto 15px;
        }
        .dna-spinner {
            width: 70px; height: 220px; position: relative;
            animation: rotateDNA 12s linear infinite, bobDNA 5s ease-in-out infinite;
            transform-style: preserve-3d;
        }
        .dna-strand {
            position: absolute; width: 100%; height: 100%;
            border-radius: 50%; box-sizing: border-box;
        }
        .dna-strand.s1 {
            border: 4px solid var(--accent-primary);
            clip-path: ellipse(50% 50% at 50% 50%);
            animation: dnaTwist1 2s ease-in-out infinite alternate;
            filter: drop-shadow(var(--accent-primary-glow));
        }
        .dna-strand.s2 {
            border: 4px solid var(--accent-secondary);
            clip-path: ellipse(50% 50% at 50% 50%);
            animation: dnaTwist2 2s ease-in-out infinite alternate;
            filter: drop-shadow(var(--accent-secondary-glow));
        }
         @keyframes dnaTwist1 { from { transform: rotateZ(0deg) scaleY(1); } to { transform: rotateZ(8deg) scaleY(0.96); } }
         @keyframes dnaTwist2 { from { transform: rotateZ(0deg) scaleY(1); } to { transform: rotateZ(-8deg) scaleY(0.96); } }
        .dna-rung {
            position: absolute; left: 50%; width: 75%; height: 3px;
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            border-radius: 1.5px; transform-origin: center;
            box-shadow: 0 0 4px rgba(152, 126, 255, 0.25);
        }
        @keyframes rotateDNA { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
        @keyframes bobDNA { 0%, 100% { transform: translateY(0px) rotateY(var(--current-y-rot)); } 50% { transform: translateY(-8px) rotateY(var(--current-y-rot)); } }

        .vital-signs-widget .widget-content { flex-direction: row; gap: 20px; align-items: center; }
        .vitals-grid-container { flex: 1 1 auto; }
        .vitals-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(105px, 1fr));
            gap: 12px; height: 100%; align-content: space-evenly;
        }
        @media (min-width: 1400px) {
            .vital-signs-widget .widget-content { flex-direction: column; align-items: center; }
            .dna-visual-container { width: clamp(160px, 45%, 220px); height: 280px; margin-bottom: 20px; }
            .vitals-grid { grid-template-columns: repeat(2, 1fr); width: 100%; max-width: 300px; }
        }

        .vital-item {
            background-color: var(--element-bg); padding: 12px 10px;
            border-radius: var(--border-radius-md); text-align: center;
            border: 1px solid var(--element-border);
            transition: all 0.25s ease-out;
        }
        .vital-item:hover {
            background-color: var(--element-hover-bg);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .vital-item i { font-size: 1.5em; margin-bottom: 8px; display: block; }
        .vital-item .value { font-size: 1.4em; font-weight: 500; color: var(--text-primary); }
        .vital-item .label { font-size: 0.7em; color: var(--text-muted); margin-top: 3px; }
        .vital-item .unit { font-size: 0.65em; color: var(--text-muted); opacity: 0.8; }
        .vital-item .mood-emoji { font-size: 1.9em; margin-bottom: 1px; }

        .chart-container { position: relative; min-height: 180px; flex-grow: 1; width: 100%; }
        .no-data-message {
            text-align: center; color: var(--text-muted); font-style: italic;
            padding: 25px 10px; align-self: center; justify-self: center;
            flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: 0.85em;
            background-color: rgba(0,0,0,0.06); border-radius: var(--border-radius-md);
            min-height: 90px; border: 1px dashed var(--widget-border);
        }
        .streaks-container .no-data-message { min-height: auto; background-color: transparent; border: none; padding: 15px 0;}

        .streaks-container { display: flex; gap: 15px; justify-content: space-around; height: 100%; align-items: center; }
        .streak-item {
            text-align: center; padding: 18px 15px;
            border-radius: var(--border-radius-md);
            background-color: var(--element-bg); border: 1px solid var(--element-border);
            flex: 1; transition: all 0.25s ease-out;
        }
         .streak-item:hover {
            background-color: var(--element-hover-bg);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .streak-item .streak-emoji { font-size: 2.1em; margin-bottom: 8px; }
        .streak-item .streak-days { font-size: 1.7em; font-weight: 600; color: var(--accent-primary); }
        .streak-item .streak-label { font-size: 0.75em; color: var(--text-muted); margin-top: 4px; }

        .small-text { font-size: 0.8em; color: var(--text-muted); text-align: center; margin-top: 25px; }
        #mockDataHelper {
             cursor: pointer; color: var(--accent-primary); text-decoration: none;
             font-weight: 500; padding: 8px 15px;
             border-radius: var(--border-radius-sm);
             transition: all 0.2s ease-out; display: inline-block;
             border: 1px solid var(--accent-primary-alpha-10);
             background-color: var(--accent-primary-alpha-10);
        }
        #mockDataHelper:hover {
            background-color: var(--element-hover-bg);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: var(--accent-primary-glow); transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Your Health Dashboard <span style="font-size: 0.7em; vertical-align: middle;">🧬</span></h1>
            <div class="calendar-widget">
                <div class="calendar-header">
                    <span class="month-year" id="monthYear">Loading...</span>
                    <div class="nav-buttons">
                        <button id="prevMonth" aria-label="Previous month"><</button>
                        <button id="nextMonth" aria-label="Next month">></button>
                    </div>
                </div>
                <div class="days-of-week">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div class="calendar-dates" id="calendarDates"></div>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="widget vital-signs-widget">
                <div class="widget-header">
                    <i class="fas fa-dna"></i>
                    <span class="widget-title">Core Vitals</span>
                </div>
                <p class="widget-description">Holistic view of your physiological and emotional state for the selected day, anchored by your unique biological rhythm.</p>
                <div class="widget-content">
                    <div class="dna-visual-container">
                        <div class="dna-spinner" id="dnaSpinner">
                            <div class="dna-strand s1"></div>
                            <div class="dna-strand s2"></div>
                        </div>
                    </div>
                    <div class="vitals-grid-container">
                        <div id="currentVitalsContent" class="vitals-grid">
                            <p class="no-data-message">Awaiting your vital signs...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="widget mood-over-time">
                <div class="widget-header"><i class="far fa-smile-beam"></i> <span class="widget-title">Emotional Spectrum</span></div>
                <p class="widget-description">Visualize your mood fluctuations over the past seven days, painting a picture of your emotional well-being.</p>
                <div class="widget-content">
                    <div class="chart-container">
                        <canvas id="moodTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="widget calorie-log">
                <div class="widget-header"><i class="fas fa-utensils"></i> <span class="widget-title">Energy Intake</span></div>
                <p class="widget-description">Track your daily caloric consumption. Bars turn red if you exceed your target for the selected period.</p>
                <div class="widget-content">
                    <div class="chart-container">
                        <canvas id="calorieLogChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="widget weight-journey">
                <div class="widget-header"><i class="fas fa-weight-scale"></i> <span class="widget-title">Mass Index</span></div>
                <p class="widget-description">Monitor your weight trend. A visual representation of your journey towards your mass goals.</p>
                <div class="widget-content">
                    <div class="chart-container">
                        <canvas id="weightTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="widget hydration-habits">
                <div class="widget-header"><i class="fas fa-glass-water-droplet"></i> <span class="widget-title">Fluid Balance</span></div>
                <p class="widget-description">Observe your daily water intake. Staying hydrated is key to overall health and energy.</p>
                <div class="widget-content">
                    <div class="chart-container">
                        <canvas id="waterIntakeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="widget streaks">
                <div class="widget-header"><i class="fas fa-medal"></i> <span class="widget-title">Consistency Metrics</span></div>
                <p class="widget-description">Celebrate your dedication! Track consecutive days of positive mood and meeting energy targets.</p>
                <div class="widget-content">
                    <div id="streaksContent" class="streaks-container">
                         <p class="no-data-message">Let's build some streaks!</p>
                    </div>
                </div>
            </div>
        </div>
        <p class="small-text">
            <span id="mockDataHelper">See an Example with Sample Data</span>
        </p>
    </div>

<script>
    // --- Application Constants ---
    const MOOD_PULSE_KEY = 'vitalsphere_moodPulseData';
    const NUTRI_LOG_KEY = 'vitalsphere_nutriLogMeals';
    const WATER_LOG_KEY = 'vitalsphere_waterData';
    const WEIGHT_LOG_KEY = 'vitalsphere_weightData';
    const CALORIE_GOAL = 2500;
    const POSITIVE_MOOD_THRESHOLD = 2; // Mood value >= this is considered positive

    // --- Global State ---
    let allMoodData = [], allNutriData = [], allWaterData = [], allWeightData = [];
    let sortedUniqueDates = [];
    let charts = {}; // Stores Chart.js instances
    let currentEffectiveDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

    // --- DOM Elements ---
    const currentVitalsContent = document.getElementById('currentVitalsContent');
    const streaksContent = document.getElementById('streaksContent');
    const mockDataHelper = document.getElementById('mockDataHelper');
    const monthYearEl = document.getElementById('monthYear');
    const datesEl = document.getElementById('calendarDates');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const dnaSpinner = document.getElementById('dnaSpinner');

    // --- Calendar State ---
    let calendarDisplayedDate = new Date(); // For the calendar's current month/year view
    let calendarSelectedDate = new Date();  // For the user-selected date
    let calendarEventDays = {}; // Indicates days with any data

    // --- Utility Functions ---
    function getCssVar(variableName) {
        
        return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim().replace(/'/g, '');
    }

    function getMoodDetail(moodValue) {
        const MOOD_DETAILS = [
            { value: 0, name: 'Subdued', emoji: '📉', color: getCssVar('--mood-color-0') },
            { value: 1, name: 'Stable', emoji: '😐', color: getCssVar('--mood-color-1') },
            { value: 2, name: 'Positive', emoji: '🙂', color: getCssVar('--mood-color-2') },
            { value: 3, name: 'Elevated', emoji: '😄', color: getCssVar('--mood-color-3') },
            { value: 4, name: 'Optimal', emoji: '🤩', color: getCssVar('--mood-color-4') }
        ];
        return MOOD_DETAILS.find(m => m.value === moodValue) || MOOD_DETAILS[1]; 
    }

    function getDailyCalories(dateStr, data) {
        return data
            .filter(meal => new Date(meal.timestamp).toISOString().split('T')[0] === dateStr)
            .reduce((sum, meal) => sum + (Number(meal.calories) || 0), 0) || null;
    }

    function getDataForDate(dateStr, dataArray, key = 'value') {
        const entry = dataArray.find(d => d.date === dateStr);
        return entry ? entry[key] : null;
    }

    function formatDateForStorage(dateObj) {
        // Consistently formats dates to YYYY-MM-DD for storage and comparison
        return dateObj.toISOString().split('T')[0];
    }

    // UI Element
    function createDNARungs() {
        if (!dnaSpinner) return;
        dnaSpinner.querySelectorAll('.dna-rung').forEach(rung => rung.remove()); 
        const numRungs = 10; // Number of rungs in the DNA visual
        for (let i = 0; i < numRungs; i++) {
            const rung = document.createElement('div');
            rung.classList.add('dna-rung');
            const yPos = (i / (numRungs -1)) * 90 + 5; 
            const rotation = i * (360 / numRungs) * 0.5; 
            rung.style.top = `${yPos}%`;
            rung.style.transform = `translate(-50%, -50%) rotateY(${rotation}deg) translateZ(0px)`;
            dnaSpinner.appendChild(rung);
        }
    }

    // --- Calendar ---
    function updateCalendarEventDays() {
        calendarEventDays = {};
        sortedUniqueDates.forEach(dateStr => { calendarEventDays[dateStr] = true; });
    }

    function renderCalendar() {
        const year = calendarDisplayedDate.getFullYear();
        const month = calendarDisplayedDate.getMonth();
        monthYearEl.textContent = `${calendarDisplayedDate.toLocaleString('default', { month: 'long' })} ${year}`;
        datesEl.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const prevMonthDaysCount = new Date(year, month, 0).getDate();

        // Days from previous month
        for (let i = 0; i < firstDayOfMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('other-month');
            dayEl.textContent = prevMonthDaysCount - firstDayOfMonth + 1 + i;
            datesEl.appendChild(dayEl);
        }

        // Days of current month
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.textContent = i;
            const fullDate = new Date(year, month, i);
            const fullDateStr = formatDateForStorage(fullDate);
            const todayStr = formatDateForStorage(new Date());

            if (fullDateStr === todayStr) dayEl.classList.add('today');
            if (calendarSelectedDate && fullDateStr === formatDateForStorage(calendarSelectedDate)) {
                dayEl.classList.add('selected');
            }
            if (calendarEventDays[fullDateStr]) {
                const dot = document.createElement('span');
                dot.classList.add('event-dot');
                dayEl.appendChild(dot);
            }
            dayEl.addEventListener('click', () => {
                calendarSelectedDate = new Date(year, month, i);
                currentEffectiveDate = formatDateForStorage(calendarSelectedDate);
                renderCalendar();
                renderDashboard();
            });
            datesEl.appendChild(dayEl);
        }
        // Days from next month to fill grid
        const totalCellsRendered = datesEl.children.length;
        const cellsToFill = (totalCellsRendered <= 35) ? 35 - totalCellsRendered : 42 - totalCellsRendered;
        for (let i = 1; i <= cellsToFill; i++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('other-month');
            dayEl.textContent = i;
            datesEl.appendChild(dayEl);
        }
    }

    prevMonthBtn.addEventListener('click', () => {
        calendarDisplayedDate.setMonth(calendarDisplayedDate.getMonth() - 1);
        renderCalendar();
    });
    nextMonthBtn.addEventListener('click', () => {
        calendarDisplayedDate.setMonth(calendarDisplayedDate.getMonth() + 1);
        renderCalendar();
    });

    // --- Data Management & Dashboard Rendering ---
    mockDataHelper.addEventListener('click', () => generateMockDataForHealthDashboard());

    function loadAllData() {
        allMoodData = JSON.parse(localStorage.getItem(MOOD_PULSE_KEY) || '[]');
        allNutriData = JSON.parse(localStorage.getItem(NUTRI_LOG_KEY) || '[]');
        allWaterData = JSON.parse(localStorage.getItem(WATER_LOG_KEY) || '[]');
        allWeightData = JSON.parse(localStorage.getItem(WEIGHT_LOG_KEY) || '[]');

        const dateSet = new Set();
        [allMoodData, allWaterData, allWeightData].forEach(arr => arr.forEach(d => d.date && dateSet.add(d.date)));
        allNutriData.forEach(d => d.timestamp && dateSet.add(new Date(d.timestamp).toISOString().split('T')[0]));
        sortedUniqueDates = Array.from(dateSet).sort((a,b) => new Date(a) - new Date(b));
        updateCalendarEventDays();

        const todayStr = formatDateForStorage(new Date());
        if (sortedUniqueDates.length > 0) {
            currentEffectiveDate = sortedUniqueDates.includes(todayStr) ? todayStr : sortedUniqueDates[sortedUniqueDates.length - 1];
            mockDataHelper.textContent = "Recalibrate Sample Data";
        } else {
            currentEffectiveDate = todayStr;
            mockDataHelper.textContent = "No Data. Try Sample Data?";
        }
        
        calendarSelectedDate = new Date(currentEffectiveDate + "T00:00:00");
        calendarDisplayedDate = new Date(calendarSelectedDate.getFullYear(), calendarSelectedDate.getMonth(), 1);
        renderCalendar();
    }

    function renderDashboard() {
        if (!currentEffectiveDate && sortedUniqueDates.length === 0 && allNutriData.length === 0) {
            displayNoDataMessages(); return;
        }
        clearNoDataMessagesFromCharts();

        const dataForSelectedPeriod = {
            mood: allMoodData.filter(d => d.date <= currentEffectiveDate),
            nutri: allNutriData.filter(d => new Date(d.timestamp).toISOString().split('T')[0] <= currentEffectiveDate),
            water: allWaterData.filter(d => d.date <= currentEffectiveDate),
            weight: allWeightData.filter(d => d.date <= currentEffectiveDate),
        };
        renderCurrentVitals(dataForSelectedPeriod);
        renderStreaks(dataForSelectedPeriod);

        const effectiveDateObj = new Date(currentEffectiveDate + "T00:00:00");
        const chartStartDate = new Date(effectiveDateObj);
        chartStartDate.setDate(effectiveDateObj.getDate() - 6); // 7-day view (current + 6 previous)
        const chartStartDateStr = formatDateForStorage(chartStartDate);

        const chartDisplayData = {
            mood: dataForSelectedPeriod.mood.filter(d => d.date >= chartStartDateStr),
            nutri: dataForSelectedPeriod.nutri.filter(d => new Date(d.timestamp).toISOString().split('T')[0] >= chartStartDateStr),
            water: dataForSelectedPeriod.water.filter(d => d.date >= chartStartDateStr),
            weight: dataForSelectedPeriod.weight.filter(d => d.date >= chartStartDateStr),
        };
        const chartPeriodDates = sortedUniqueDates.filter(d => d >= chartStartDateStr && d <= currentEffectiveDate);

        renderMoodTrendChart(chartDisplayData.mood, chartPeriodDates);
        renderCalorieLogChart(chartDisplayData.nutri, chartPeriodDates);
        renderWeightTrendChart(chartDisplayData.weight, chartPeriodDates);
        renderWaterIntakeChart(chartDisplayData.water, chartPeriodDates);
    }

    function displayNoDataMessages() {
        currentVitalsContent.innerHTML = '<p class="no-data-message">Log activities to see vital signs.</p>';
        streaksContent.innerHTML = '<p class="no-data-message">Log data to build consistency.</p>';
        Object.values(charts).forEach(chart => chart?.destroy());
        charts = {};
        document.querySelectorAll('.chart-container').forEach(cc => {
            const canvasId = cc.querySelector('canvas')?.id;
            if (canvasId) setupChartNoData(canvasId, 'Insufficient data for this period.');
        });
    }

    function clearNoDataMessagesFromCharts() {
        document.querySelectorAll('.chart-container').forEach(cc => {
            cc.querySelector('.no-data-message')?.remove();
            const canvas = cc.querySelector('canvas');
            if (canvas) canvas.style.display = 'block';
        });
    }

    function renderCurrentVitals(data) {
        const moodEntry = data.mood.find(m => m.date === currentEffectiveDate);
        const mood = moodEntry ? getMoodDetail(moodEntry.mood) : getMoodDetail(1);
        const calories = getDailyCalories(currentEffectiveDate, data.nutri);
        const weight = getDataForDate(currentEffectiveDate, data.weight, 'weight');
        const water = getDataForDate(currentEffectiveDate, data.water, 'amount');

        currentVitalsContent.innerHTML = `
            <div class="vital-item">
                <i class="far fa-smile icon-mood" style="color: ${mood.color};"></i>
                <div class="value mood-emoji">${mood.emoji}</div><div class="label">${mood.name}</div>
            </div>
            <div class="vital-item">
                <i class="fas fa-fire-alt icon-calories"></i>
                <div class="value">${calories !== null ? calories : 'N/A'}</div><div class="label">Energy <span class="unit">(kcal)</span></div>
            </div>
            <div class="vital-item">
                <i class="fas fa-weight icon-weight"></i>
                <div class="value">${weight !== null ? weight : 'N/A'}</div><div class="label">Mass <span class="unit">(kg)</span></div>
            </div>
            <div class="vital-item">
                <i class="fas fa-tint icon-water"></i>
                <div class="value">${water !== null ? (water / 1000).toFixed(1) : 'N/A'}</div><div class="label">Fluids <span class="unit">(L)</span></div>
            </div>`;
    }

    function renderStreaks(data) {
        let moodStreak = 0;
        const relevantDates = sortedUniqueDates.filter(d => d <= currentEffectiveDate).reverse();
        for (const date of relevantDates) {
            const entry = data.mood.find(m => m.date === date);
            if (entry && entry.mood >= POSITIVE_MOOD_THRESHOLD) moodStreak++; else break;
        }
        let calorieStreak = 0;
        for (const date of relevantDates) {
            const dailyCal = getDailyCalories(date, data.nutri);
            if (dailyCal !== null && dailyCal > 0 && dailyCal <= CALORIE_GOAL) calorieStreak++;
            else if (dailyCal !== null && dailyCal > 0) break;
        }
        streaksContent.innerHTML = `
            <div class="streak-item">
                <div class="streak-emoji">${moodStreak > 0 ? (moodStreak > 3 ? '🌟' : '👍') : '🔄'}</div>
                <div class="streak-days">${moodStreak}</div><div class="streak-label">Positive State</div>
            </div>
            <div class="streak-item">
                <div class="streak-emoji">${calorieStreak > 0 ? (calorieStreak > 3 ? '🏆' : '✅') : '🎯'}</div>
                <div class="streak-days">${calorieStreak}</div><div class="streak-label">Energy Target</div>
            </div>`;
    }

    // --- Chart Configuration and Rendering ---
    const commonChartOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: 'rgba(18, 22, 38, 0.95)', titleColor: getCssVar('--accent-primary'),
                bodyColor: getCssVar('--text-primary'), borderColor: getCssVar('--pane-border'),
                borderWidth: 1, padding: 10, cornerRadius: parseFloat(getCssVar('--border-radius-md')),
                boxPadding: 5, titleFont: { weight: '500', size: 13 }, bodyFont: { weight: '300', size: 12 },
                displayColors: false,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) { label += ': '; }
                        if (context.parsed.y !== null) {
                             if (context.chart.id === 'moodTrendChart') return getMoodDetail(context.parsed.y).name;
                            label += context.parsed.y;
                             if (context.chart.id === 'calorieLogChart') label += ' kcal';
                             if (context.chart.id === 'weightTrendChart') label += ' kg';
                             if (context.chart.id === 'waterIntakeChart') label += ' ml';
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                type: 'time', time: { unit: 'day', tooltipFormat: 'MMM d, yyyy', displayFormats: { day: 'd' } },
                grid: { display: false },
                ticks: { color: getCssVar('--text-muted'), font: { size: 10, weight: '300' }, maxRotation: 0, autoSkipPadding: 10 }
            },
            y: {
                beginAtZero: true,
                grid: { color: getCssVar('--widget-border'), drawBorder: false, lineWidth: 0.4 },
                ticks: { color: getCssVar('--text-muted'), font: { size: 10, weight: '300' }, padding: 6 }
            }
        },
        interaction: { intersect: false, mode: 'index' },
    };

    function setupChartNoData(canvasId, message = 'No data to display for this period.') {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const parent = canvas.parentElement;
        canvas.style.display = 'none';
        let msgEl = parent.querySelector('.no-data-message');
        if (!msgEl) {
            msgEl = document.createElement('p');
            msgEl.className = 'no-data-message';
            parent.appendChild(msgEl);
        }
        msgEl.textContent = message;
    }

    function renderChart(canvasId, type, data, customOptions = {}) {
        if (charts[canvasId]) charts[canvasId].destroy();
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Check if all datasets within the data are empty
        const noDataInDatasets = !data || data.datasets.every(ds => ds.data.length === 0);

        if (noDataInDatasets) {
             let noDataMessage = 'No data available for this period.'; 
             if (canvasId === 'moodTrendChart') noDataMessage = 'Log mood entries to see your spectrum.';
             else if (canvasId === 'calorieLogChart') noDataMessage = 'Log meals to track energy intake.';
             else if (canvasId === 'weightTrendChart') noDataMessage = 'Log weight to see your progress.';
             else if (canvasId === 'waterIntakeChart') noDataMessage = 'Log water intake for fluid balance.';
            setupChartNoData(canvasId, noDataMessage);
            return;
        }
        canvas.style.display = 'block';
        charts[canvasId] = new Chart(canvas.getContext('2d'), {
            type,
            data,
            options: { ...commonChartOptions, ...customOptions } 
        });
    }

    function renderMoodTrendChart(moodData, dates) {
        const dataPoints = dates.map(date => ({ x: date, y: getDataForDate(date, moodData, 'mood') }));
        renderChart('moodTrendChart', 'line', {
            datasets: [{
                label: 'Mood', data: dataPoints, borderColor: getCssVar('--accent-secondary'),
                backgroundColor: dataPoints.map(dp => dp.y !== null ? getMoodDetail(dp.y).color : 'rgba(120,120,120,0.1)'),
                pointRadius: 4, pointHoverRadius: 7, pointBorderColor: getCssVar('--widget-bg'),
                pointBorderWidth: 1.5, tension: 0.35, spanGaps: true,
            }]
        }, { scales: { y: { min: 0, max: 4, ticks: { stepSize: 1, callback: val => getMoodDetail(val).emoji } } } });
    }

    function renderCalorieLogChart(nutriData, dates) {
        const dataPoints = dates.map(date => ({ x: date, y: getDailyCalories(date, nutriData) }));
        renderChart('calorieLogChart', 'bar', {
            datasets: [{
                label: 'Calories', data: dataPoints,
                backgroundColor: dataPoints.map(dp => (dp.y || 0) > CALORIE_GOAL ? getCssVar('--danger-accent') : getCssVar('--accent-primary')),
                borderWidth: 0, borderRadius: 5, borderSkipped: false,
                barPercentage: 0.55, categoryPercentage: 0.65
            }]
        });
    }

    function renderWeightTrendChart(weightData, dates) {
        const dataPoints = dates.map(date => ({ x: date, y: getDataForDate(date, weightData, 'weight') }));
        renderChart('weightTrendChart', 'line', {
            datasets: [{
                label: 'Weight (kg)', data: dataPoints, borderColor: getCssVar('--accent-secondary'),
                backgroundColor: getCssVar('--accent-secondary-alpha-10'), fill: 'start',
                tension: 0.35, pointRadius: 3, pointBackgroundColor: getCssVar('--accent-secondary'),
                pointBorderColor: getCssVar('--widget-bg'), pointBorderWidth: 1.5,
                pointHoverRadius: 7, spanGaps: true,
            }]
        });
    }

    function renderWaterIntakeChart(waterData, dates) {
        const dataPoints = dates.map(date => ({ x: date, y: getDataForDate(date, waterData, 'amount') }));
        renderChart('waterIntakeChart', 'bar', {
            datasets: [{
                label: 'Water (ml)', data: dataPoints, backgroundColor: getCssVar('--accent-primary'),
                borderWidth: 0, borderRadius: 5, borderSkipped: false,
                barPercentage: 0.55, categoryPercentage: 0.65
            }]
        });
    }

    // --- Mock Data Generation ---
    window.generateMockDataForHealthDashboard = function() {
        const today = new Date(); const mockMood = []; const mockNutri = []; const mockWater = []; const mockWeight = [];
        let currentWeight = 72 + (Math.random() - 0.5) * 8; // Starting weight around 72kg

        for (let i = 45; i >= 0; i--) { // Generate data for the last 45 days
            const date = new Date(today); date.setDate(today.getDate() - i);
            const dateStr = formatDateForStorage(date);

            mockMood.push({ date: dateStr, mood: Math.floor(Math.random() * 5) }); // Random mood 0-4

            if (Math.random() > 0.1) { // 90% chance to log meals
                const numMeals = Math.floor(Math.random() * 2) + 1; // 1-3 meals
                for (let j = 0; j < numMeals; j++) {
                    const mealCals = 200 + Math.floor(Math.random() * 650); // Calories between 200-850
                    const mealTime = new Date(dateStr);
                    mealTime.setHours(8 + Math.floor(Math.random() * 12), Math.floor(Math.random() * 60)); // Random meal time
                    mockNutri.push({ id: `${dateStr}-m-${j}`, name: `Meal ${j+1}`, calories: mealCals, emoji: '🍽️', timestamp: mealTime.getTime() });
                }
            }
            if (Math.random() > 0.15) { // 85% chance to log water
                mockWater.push({ date: dateStr, amount: (Math.floor(Math.random() * 10) + 2) * 250 }); // 500ml to 3000ml
            }
            if (i % (Math.floor(Math.random()*2)+2) === 0 && Math.random() > 0.25) { // Log weight periodically
                 currentWeight += (Math.random() - 0.51) * (Math.random() * 0.7 + 0.1); // Small weight fluctuations
                 mockWeight.push({ date: dateStr, weight: parseFloat(currentWeight.toFixed(1)) });
            }
        }
        localStorage.setItem(MOOD_PULSE_KEY, JSON.stringify(mockMood));
        localStorage.setItem(NUTRI_LOG_KEY, JSON.stringify(mockNutri));
        localStorage.setItem(WATER_LOG_KEY, JSON.stringify(mockWater));
        localStorage.setItem(WEIGHT_LOG_KEY, JSON.stringify(mockWeight));
        loadAllData(); renderDashboard(); // Reload and render all data
    };

    // --- UI Enhancements ---
    function observeWidgets() {
        const widgets = document.querySelectorAll('.widget');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 }); 
        widgets.forEach(widget => { observer.observe(widget); });
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        
        Chart.defaults.font.family = getCssVar('--font-family');
        Chart.defaults.font.weight = '300';
        Chart.defaults.color = getCssVar('--text-muted');

        createDNARungs();
        loadAllData();
        renderDashboard();
        observeWidgets();
    });
</script>
</body>
</html>
